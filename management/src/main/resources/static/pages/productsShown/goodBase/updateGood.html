<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改商品</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../../../css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="../../../css/global.css" media="all"/>
    <link rel="stylesheet" href="../../../css/font-awesome/css/font-awesome.css" media="all"/>
    <link rel="stylesheet" href="../../../css/ztree/zTreeStyle/zTreeStyle.css" type="text/css">
    <link rel="stylesheet" href="../../../css/ztree/demo.css" type="text/css">
</head>
<body>
<div class="layui-body" style="bottom: 0; top: 5px; left: 5px; right: 5px; border: solid 1px #5f5f5f;"
     id="admin-body">
    <div class="layui-tab admin-nav-card layui-tab-brief">
        <ul class="layui-tab-title">
            <li class="layui-this">商品基础信息</li>
            <li>商品信息</li>
            <li id="discountInfo" style="display: none;">商品优惠信息</li>
            <li>商品配送信息</li>
            <li>商品封面</li>
        </ul>
        <div class="layui-tab-content" style="padding: 5px 0 0 0;">
            <div class="layui-tab-item layui-show">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <form class="form-horizontal" onsubmit="return false" id="form1">
                        <fieldset>
                            <div class="form-group">
                                <label class="col-md-2 control-label">分類</label>
                                <div class="col-md-10">
                                    <select name="categoryId" class="form-control input-sm" id="categoryId"
                                            data-bv-notempty="true" data-bv-notempty-message="分類 不能為空">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">商品Id</label>
                                <div class="col-md-10">
                                    <input class="form-control" type="text" name="goodId"
                                           id="goodId" readonly="readonly">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">商品名</label>
                                <div class="col-md-10">
                                    <input class="form-control" type="text" name="goodName"
                                           id="goodName"
                                           data-bv-notempty="true" data-bv-notempty-message="商品名 不能為空">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">價格區間</label>
                                <div class="col-md-10">
                                    $ <input class="form-control-money" type="number" name="goodMinPrice"
                                             id="goodMinPrice" value=0.00 step="0.01"> -
                                    $ <input class="form-control-money" type="number" name="goodMaxPrice"
                                             id="goodMaxPrice" value=0.00 step="0.01">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">是否特價</label>
                                <div class="col-md-10">
                                    <input type="checkbox" name="isSpecialPrice" id="isSpecialPrice">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label" id="specialPriceTitle"
                                       style="display: none;">特價價格</label>
                                <div class="col-md-10" id="specialPriceDiv" style="display: none;">
                                    $ <input class="form-control-money" type="number" name="specialPrice"
                                             id="specialPrice" value=0.00 step="0.01">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">是否有折扣</label>
                                <div class="col-md-10">
                                    <input type="checkbox" name="isDiscount" id="isDiscount">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">庫存</label>
                                <div class="col-md-10">
                                    <input class="form-control" type="number" name="stock"
                                           id="stock" value=0>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">售賣時間</label>
                                <div class="col-md-10">
                                    <input class="form-control" name="sellTime"
                                           id="sellTime" data-bv-notempty="true" data-bv-notempty-message="售賣時間 不能為空">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">售賣狀態</label>
                                <div class="col-md-10">
                                    <select name="sellStatus" class="form-control input-sm" id="sellStatus"
                                            data-bv-notempty="true" data-bv-notempty-message="售賣狀態 不能為空">
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <form class="form-horizontal" onsubmit="return false" id="form2">
                        <fieldset>
                            <div class="form-group">
                                <label class="col-md-2 control-label">商品描述</label>
                                <div class="col-md-10">
                                    <textarea class="form-control" type="text" name="goodDescribe" id="goodDescribe"
                                              style="height: 200px"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">商品規格</label>
                                <div class="col-md-10">
                                    <input class="form-control" type="text" name="goodSize" id="goodSize">
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <form class="form-horizontal" onsubmit="return false" id="form3" style="display: none;">
                        <fieldset>
                            <div class="form-group">
                                <label class="col-md-2 control-label">打多少折</label>
                                <div class="col-md-10">
                                    - <input class="form-control-money" type="number" name="discountOff"
                                             id="discountOff" value=0 step="1"> %
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">滿多少錢</label>
                                <div class="col-md-10">
                                    $ <input class="form-control-money" type="number" name="fullPrice"
                                             id="fullPrice" value=0.00 step="0.01">
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <form class="form-horizontal" onsubmit="return false" id="form4">
                        <fieldset>
                            <div class="form-group">
                                <label class="col-md-2 control-label">配送方式</label>
                                <div class="col-md-10">
                                    <ul id="deliverWay" class="ztree"></ul>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="uploadCover">上传图片</button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" id="demo1" style="display:inline-block;width:90px;height:90px">
                            <p id="demoText"></p>
                        </div>
                        <div style="width: 95px;">
                            <div class="layui-progress layui-progress-big" lay-showpercent="yes" lay-filter="demo">
                                <div class="layui-progress-bar" lay-percent=""></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-actions">
        <div class="row" align="center">
            <div class="col-md-12">
                <button class="btn btn-primary" onclick="location.href='goodList.html'">返回
                </button>
                <button class="btn btn-primary" type="submit" onclick="update()">
                    <i class="fa fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script type="text/javascript" src="../../../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../../js/jq.js"></script>
<script type="text/javascript" src="../../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
<script type="text/javascript" src="../../../js/common.js"></script>
<script type="text/javascript" src="../../../layui/layui.js"></script>
<script type="text/javascript" src="../../../js/dict.js"></script>
<script type="text/javascript" src="../../../js/libs/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="../../../js/my/ztree-deliver.js"></script>
<script type="text/javascript">
    var pro = window.location.protocol;
    var host = window.location.host;
    var domain = pro + "//" + host;
    layui.use(['layer', 'element', 'upload'], function () {
        var $ = layui.jquery
            ,upload = layui.upload
            ,element = layui.element
            ,layer = layui.layer;
        //常规使用 - 普通图片上传
        var uploadInst = upload.render({
            elem: '#uploadCover'
            , url: '/productsShown/good/uploadCover'
            , before: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#demo1').width(undefined);
                    $('#demo1').height(200);
                    $('#demo1').attr('src', result); //图片链接（base64）
                });
                this.data = {
                    goodId: document.getElementById("goodId").value,
                    domain: domain,
                }
                element.progress('demo', '0%'); //进度条复位
                layer.msg('上传中', {icon: 16, time: 0});
            }
            , done: function (res) {
                //上传成功的一些操作
                if (res.code === 0) {
                    element.progress('demo', '100%');
                    return layer.msg('上传成功');
                } else { //如果上传失败
                    return layer.msg('上传失败');
                }
                $('#demoText').html(''); //置空上传失败的状态
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadInst.upload();
                });
            }
            //进度条
            , progress: function (n, elem, e) {
                element.progress('demo', n + '%'); //可配合 layui 进度条元素使用
                if (n == 100) {
                    layer.msg('上传完毕', {icon: 1});
                }
            }
        });
    });
    layui.use('laydate', function () {
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#sellTime' //指定元素
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm:ss'
        });
    });
    showCategoryByAppId("categoryId", "categoryName", "", appId);
    showCompanyByAppId("companyId", "companyId", "", appId);
    showDictSelect("sellStatus", "sellStatus", "");
    $.fn.zTree.init($("#deliverWay"), getSettting(), getDeliverTree());
    initData();
    var appId = $('#appId').val();
    $('#goodMinPrice').blur(function () {
        var minPrice = $('#goodMinPrice').val();
        var maxPrice = $('#goodMaxPrice').val();
        if (minPrice > maxPrice) {
            $('#goodMaxPrice').val(minPrice);
        }
    });
    $('#goodMaxPrice').blur(function () {
        var minPrice = $('#goodMinPrice').val();
        var maxPrice = $('#goodMaxPrice').val();
        if (minPrice > maxPrice) {
            $('#goodMaxPrice').val(minPrice);
        }
    });
    $('#discountOff').blur(function () {
        var discountOff = $('#discountOff').val();
        if (discountOff > 100) {
            $('#discountOff').val(100);
        }
    });
    $(function () {
        $("#isSpecialPrice").click(function () {
            if (this.checked == true) {
                $('#specialPriceDiv').show();
                $('#specialPriceTitle').show();
                $('#specialPrice').val(0);
            } else {
                $('#specialPriceDiv').hide();
                $('#specialPriceTitle').hide();
                $('#specialPrice').val(null);
            }
        });
    });
    $(function () {
        $("#isDiscount").click(function () {
            if (this.checked == true) {
                $('#discountInfo').show();
                $('#form3').show();
                $('#discountOff').val(0);
                $('#fullPrice').val(0);
            } else {
                $('#discountInfo').hide();
                $('#form3').hide();
                $('#discountOff').val(null);
                $('#fullPrice').val(null);
            }
        });
    });

    function initData() {
        var goodId = getUrlParam("goodId");
        if (goodId != "") {
            $.ajax({
                type: 'get',
                url: '/productsShown/good/getGoodByParam?goodId=' + goodId,
                async: false,
                success: function (data) {
                    var categoryId = document.getElementById('categoryId');
                    for (var i = 0; i < categoryId.options.length; i++) {
                        if (categoryId.options[i].value == data.categoryId) {
                            categoryId.options[i].selected = true;
                            break;
                        }
                    }
                    $('#goodId').val(data.goodId);
                    $('#goodName').val(data.goodName);
                    $('#goodMinPrice').val(data.goodMinPrice);
                    $('#goodMaxPrice').val(data.goodMaxPrice);
                    if (data.goodCoverImg != null || data.goodCoverImg !== "") {
                        $('#demo1').width(undefined);
                        $('#demo1').height(200);
                        $('#demo1').attr('src', data.goodCoverImg);
                    }
                    if (data.isSpecialPrice === 1) {
                        $('#isSpecialPrice').attr('checked',true);
                        $('#isSpecialPrice').val("on");
                        $('#specialPriceDiv').show();
                        $('#specialPriceTitle').show();
                    } else if (data.isSpecialPrice === 0) {
                        $('#isSpecialPrice').val("off");
                        $('#specialPriceDiv').hide();
                        $('#specialPriceTitle').hide();
                    }
                    $('#specialPrice').val(data.specialPrice);
                    if (data.isDiscount === 1) {
                        $('#isDiscount').attr('checked',true);
                        $('#isDiscount').val("on");
                        $('#discountInfo').show();
                        $('#form3').show();
                    } else if (data.isDiscount === 0) {
                        $('#isDiscount').val("off");
                        $('#discountInfo').hide();
                        $('#form3').hide();
                    }
                    $('#stock').val(data.stock);
                    $('#sellTime').val(data.sellTime);
                    var sellStatus = document.getElementById('sellStatus');
                    for (var i = 0; i < sellStatus.options.length; i++) {
                        if (sellStatus.options[i].value == data.sellStatus) {
                            sellStatus.options[i].selected = true;
                            break;
                        }
                    }
                    $('#goodDescribe').val(data.goodDescribe);
                    $('#goodSize').val(data.goodSize);
                    $('#discountOff').val(data.discountOff);
                    $('#fullPrice').val(data.fullPrice);
                    initDeliverWayDatas(data.goodId);
                }
            });
        }
    }

    function update() {
        if ($('#isSpecialPrice').val() === ("on")) {
            $('#isSpecialPrice').val(1);
        } else if ($('#isSpecialPrice').val() === ("off")) {
            $('#isSpecialPrice').val(0);
        }
        if ($('#isDiscount').val() === ("on")) {
            $('#isDiscount').val(1);
        } else if ($('#isDiscount').val() === ("off")) {
            $('#isDiscount').val(0);
        }
        $('#form1').bootstrapValidator();
        var bootstrapValidator = $("#form1").data('bootstrapValidator');
        bootstrapValidator.validate();
        if (!bootstrapValidator.isValid()) {
            return;
        }
        $('#form2').bootstrapValidator();
        var bootstrapValidator = $("#form2").data('bootstrapValidator');
        bootstrapValidator.validate();
        if (!bootstrapValidator.isValid()) {
            return;
        }
        $('#form3').bootstrapValidator();
        var bootstrapValidator = $("#form3").data('bootstrapValidator');
        bootstrapValidator.validate();
        if (!bootstrapValidator.isValid()) {
            return;
        }
        $('#form4').bootstrapValidator();
        var bootstrapValidator = $("#form4").data('bootstrapValidator');
        bootstrapValidator.validate();
        if (!bootstrapValidator.isValid()) {
            return;
        }
        var formData = $("#form1").serializeObject();
        var formData = $("#form2").addSerializeObject(formData);
        var formData = $("#form3").addSerializeObject(formData);
        var formData = $("#form4").addSerializeObject(formData);
        formData.deliverWay = getCheckedDeliverIds();
        $.ajax({
            type: 'post',
            url: '/productsShown/good',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(formData),
            success: function (data) {
                layer.msg("修改成功", {shift: -1, time: 1000}, function () {
                    location.href = "goodList.html";
                });
            }
        });
    }

    layui.use(['layer', 'element'], function () {
        var $ = layui.jquery,
            layer = layui.layer;
        var element = layui.element; //导航的hover效果、二级菜单等功能，需要依赖element模块

        //iframe自适应
        function resize() {
            var $content = $('.admin-nav-card .layui-tab-content');
            $content.height($(this).height() - 147);
            $content.find('iframe').each(function () {
                $(this).height($content.height());
            });
        }

        $(window).on('resize', function () {
            var $content = $('.admin-nav-card .layui-tab-content');
            $content.height($(this).height() - 147);
            $content.find('iframe').each(function () {
                $(this).height($content.height());
            });
        }).resize();
        //toggle左侧菜单
        $('.admin-side-toggle').on('click', function () {
            var sideWidth = $('#admin-side').width();
            if (sideWidth === 200) {
                $('#admin-body').animate({
                    left: '0'
                });
                $('#admin-footer').animate({
                    left: '0'
                });
                $('#admin-side').animate({
                    width: '0'
                });
            } else {
                $('#admin-body').animate({
                    left: '200px'
                });
                $('#admin-footer').animate({
                    left: '200px'
                });
                $('#admin-side').animate({
                    width: '200px'
                });
            }
        });
        //手机设备的简单适配
        var treeMobile = $('.site-tree-mobile'),
            shadeMobile = $('.site-mobile-shade');
        treeMobile.on('click', function () {
            $('body').addClass('site-mobile');
        });
        shadeMobile.on('click', function () {
            $('body').removeClass('site-mobile');
        });
    });
</script>